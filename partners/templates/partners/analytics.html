{% extends 'partners/base.html' %}
{% load static %}

{% block title %}Analytiques AvancÃ©es{% endblock %}
{% block page_title %}ğŸ“ˆ Analytiques AvancÃ©es<span>depuis le {{ start_date|date:"d/m/Y" }}</span>{% endblock %}

{% block extra_css %}
<style>
    .period-filter {
        display: flex;
        gap: 4px;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .period-btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.6);
        background: transparent;
        text-decoration: none;
        transition: all 0.2s;
    }

    .period-btn:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
    }

    .period-btn.active {
        background: linear-gradient(135deg, #00d084, #00a86b);
        color: #fff;
    }

    .chart-container {
        height: 300px;
        position: relative;
    }

    .stat-bar-container {
        flex: 1;
        margin: 0 16px;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .stat-bar {
        height: 100%;
        background: linear-gradient(90deg, #00d084, #00a86b);
        border-radius: 3px;
    }

    .insights-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }

    .insight-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: flex-end; margin-bottom: 24px;">
    <div class="period-filter">
        <a href="?period=week" class="period-btn {% if period == 'week' %}active{% endif %}">7 jours</a>
        <a href="?period=month" class="period-btn {% if period == 'month' %}active{% endif %}">30 jours</a>
        <a href="?period=quarter" class="period-btn {% if period == 'quarter' %}active{% endif %}">90 jours</a>
        <a href="?period=year" class="period-btn {% if period == 'year' %}active{% endif %}">1 an</a>
    </div>
</div>

<!-- KPI Cards -->
<div class="kpi-grid" style="grid-template-columns: repeat(6, 1fr);">
    <div class="kpi-card">
        <div class="icon">ğŸ“¦</div>
        <div class="value" style="color: #42a5f5;">{{ stats.total_orders }}</div>
        <div class="label">Commandes</div>
    </div>
    <div class="kpi-card">
        <div class="icon">âœ…</div>
        <div class="value" style="color: #00d084;">{{ stats.completed_orders }}</div>
        <div class="label">SuccÃ¨s</div>
    </div>
    <div class="kpi-card">
        <div class="icon">âŒ</div>
        <div class="value" style="color: #ff5252;">{{ stats.cancelled_orders }}</div>
        <div class="label">AnnulÃ©es</div>
    </div>
    <div class="kpi-card">
        <div class="icon">âš–ï¸</div>
        <div class="value" style="color: #ffc107;">{{ stats.total_disputes }}</div>
        <div class="label">Litiges</div>
    </div>
    <div class="kpi-card">
        <div class="icon">ğŸ’°</div>
        <div class="value" style="color: #00bcd4;">{{ stats.total_revenue|floatformat:0 }}</div>
        <div class="label">Volume (XAF)</div>
    </div>
    <div class="kpi-card">
        <div class="icon">ğŸ“Š</div>
        <div class="value" style="color: #ab47bc;">{{ stats.success_rate }}%</div>
        <div class="label">Taux SuccÃ¨s</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“ˆ Ã‰volution des Commandes</h2>
        </div>
        <div class="chart-container">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h2>ğŸ¯ RÃ©partition par Statut</h2>
        </div>
        <div class="chart-container">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
    <div class="card">
        <div class="card-header">
            <h2>â° Heures de Pointe</h2>
        </div>
        <div class="chart-container" style="height: 220px;">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h2>ğŸ˜ï¸ Top Quartiers</h2>
        </div>
        <div class="chart-container" style="height: 220px;">
            <canvas id="neighborhoodChart"></canvas>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“‹ MÃ©triques ClÃ©s</h2>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <div
                style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <span style="color: rgba(255,255,255,0.5);">Valeur moyenne</span>
                <span style="font-weight: 600; color: #00d084;">{{ stats.avg_order_value|floatformat:0 }} XAF</span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <span style="color: rgba(255,255,255,0.5);">Taux litiges</span>
                <span
                    style="font-weight: 600; color: {% if stats.dispute_rate < 5 %}#00d084{% else %}#ff5252{% endif %};">{{
                    stats.dispute_rate }}%</span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <span style="color: rgba(255,255,255,0.5);">Litiges rÃ©solus</span>
                <span style="font-weight: 600;">{{ stats.resolved_disputes }} / {{ stats.total_disputes }}</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>ğŸ’¡ Insights Automatiques</h2>
    </div>
    <div class="insights-grid">
        <div class="insight-card">
            <div style="font-size: 1.5rem; margin-bottom: 8px;">ğŸ“Š</div>
            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">Commande Moyenne</div>
            <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">
                Votre valeur moyenne est de {{ stats.avg_order_value|floatformat:0 }} XAF.
                {% if stats.avg_order_value > 2000 %}Excellent ! ğŸ”¥{% endif %}
            </div>
        </div>
        <div class="insight-card">
            <div style="font-size: 1.5rem; margin-bottom: 8px;">âœ…</div>
            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">FiabilitÃ©</div>
            <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">
                Taux de succÃ¨s de {{ stats.success_rate }}%.
                {% if stats.success_rate >= 95 %}ğŸ† Performance remarquable !{% endif %}
            </div>
        </div>
        <div class="insight-card">
            <div style="font-size: 1.5rem; margin-bottom: 8px;">âš–ï¸</div>
            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">Taux de Litiges</div>
            <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">
                {{ stats.dispute_rate }}% des commandes.
                {% if stats.dispute_rate < 2 %}âœ… Excellent contrÃ´le qualitÃ©.{% else %}âš ï¸ Attention Ã  la qualitÃ©.{% endif %} </div>
            </div>
            <div class="insight-card">
                <div style="font-size: 1.5rem; margin-bottom: 8px;">ğŸ“¦</div>
                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">Volume de ventes</div>
                <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">
                    {{ stats.total_orders }} commandes sur la pÃ©riode.
                    Keep it up ! ğŸš€
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        const colors = {
            green: '#00d084',
            greenLight: 'rgba(0, 208, 132, 0.1)',
            blue: '#42a5f5',
            blueLight: 'rgba(66, 165, 245, 0.1)',
            red: '#ff5252',
            yellow: '#ffc107',
            purple: '#ab47bc',
            orange: '#ff9800',
            teal: '#009688',
            gridColor: 'rgba(255, 255, 255, 0.05)',
            textColor: 'rgba(255, 255, 255, 0.5)',
        };

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: colors.textColor, font: { size: 11 } } }
            },
            scales: {
                x: {
                    grid: { color: colors.gridColor },
                    ticks: { color: colors.textColor, font: { size: 10 } }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: colors.gridColor },
                    ticks: { color: colors.textColor }
                }
            }
        };

        const dailyData = {{ daily_chart_json| safe }};
        new Chart(document.getElementById('dailyChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: 'Commandes',
                    data: dailyData.map(d => d.orders),
                    borderColor: colors.green,
                    backgroundColor: colors.greenLight,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: commonOptions
        });

        const hourlyData = {{ hourly_data_json| safe }};
        new Chart(document.getElementById('hourlyChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: Array.from({ length: 24 }, (_, i) => `${i}h`),
                datasets: [{
                    label: 'Commandes',
                    data: hourlyData,
                    backgroundColor: colors.green,
                    borderRadius: 4
                }]
            },
            options: commonOptions
        });

        const statusData = {{ status_chart_json| safe }};
        const statusColors = {
            'PENDING': colors.yellow, 'ASSIGNED': colors.blue, 'COMPLETED': colors.green, 'CANCELLED': colors.red,
        };
        new Chart(document.getElementById('statusChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: statusData.map(s => s.label),
                datasets: [{
                    data: statusData.map(s => s.count),
                    backgroundColor: statusData.map(s => statusColors[s.status] || '#666'),
                    borderWidth: 0
                }]
            },
            options: {
                ...commonOptions,
                cutout: '70%',
                plugins: { legend: { position: 'bottom' } }
            }
        });

        const neighborhoodData = {{ neighborhood_chart_json| safe }};
        new Chart(document.getElementById('neighborhoodChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: neighborhoodData.map(n => n.name),
                datasets: [{
                    label: 'Commandes',
                    data: neighborhoodData.map(n => n.count),
                    backgroundColor: colors.blue,
                    borderRadius: 4
                }]
            },
            options: { ...commonOptions, indexAxis: 'y' }
        });
    </script>
    {% endblock %}