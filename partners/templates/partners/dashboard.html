{% extends 'partners/base.html' %}
{% load static %}

{% block title %}Vue d'ensemble{% endblock %}
{% block page_title %}Dashboard<span>Vue d'ensemble</span>{% endblock %}

{% block content %}
{% if not is_approved %}
<!-- NOT APPROVED STATE -->
<div class="card">
    <h2>â³ Compte en attente de validation</h2>
    <div class="alert alert-warning" style="margin-top: 16px; margin-bottom: 0;">
        Votre compte vendeur est en cours de vÃ©rification par notre Ã©quipe.
        Vous recevrez une notification WhatsApp dÃ¨s que votre compte sera activÃ©.
    </div>
</div>
{% else %}

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="icon">ğŸ“¦</div>
        <div class="value">{{ stats.today_orders }}</div>
        <div class="label">Commandes aujourd'hui</div>
        <div
            style="margin-top: 12px; font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; display: inline-block; background: rgba(0, 208, 132, 0.15); color: #00d084;">
            ğŸ“ˆ {{ stats.week_orders }} cette semaine</div>
    </div>
    <div class="kpi-card">
        <div class="icon">ğŸ’°</div>
        <div class="value">{{ stats.today_revenue|floatformat:0 }} <small style="font-size: 1rem;">XAF</small></div>
        <div class="label">Revenus aujourd'hui</div>
        <div
            style="margin-top: 12px; font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; display: inline-block; background: rgba(0, 208, 132, 0.15); color: #00d084;">
            {{ stats.week_revenue|floatformat:0 }} XAF cette semaine</div>
    </div>
    <div class="kpi-card">
        <div class="icon">âœ…</div>
        <div class="value">{{ stats.success_rate }}%</div>
        <div class="label">Taux de livraison</div>
        <div
            style="margin-top: 12px; font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; display: inline-block; background: {% if stats.success_rate >= 90 %}rgba(0, 208, 132, 0.15){% else %}rgba(255, 82, 82, 0.15){% endif %}; color: {% if stats.success_rate >= 90 %}#00d084{% else %}#ff5252{% endif %};">
            {{ stats.total_orders }} livraisons totales
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon">ğŸ’³</div>
        <div class="value {% if stats.wallet_balance >= 0 %}status-completed{% else %}status-failed{% endif %}"
            style="background: none;">
            {{ stats.wallet_balance|floatformat:0 }}
        </div>
        <div class="label">Solde Wallet (XAF)</div>
        <div
            style="margin-top: 12px; font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; display: inline-block; color: rgba(255,255,255,0.5);">
            Plafond: {{ stats.debt_ceiling|floatformat:0 }} XAF</div>
    </div>
</div>

<!-- Chart + Top Zones -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“ˆ Ã‰volution des Commandes</h2>
            <span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">7 derniers jours</span>
        </div>
        <div style="height: 280px;">
            <canvas id="ordersChart"></canvas>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h2>ğŸ† Top Quartiers</h2>
        </div>
        <ul style="list-style: none;">
            {% for n in stats.top_neighborhoods %}
            <li
                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                <span style="color: rgba(255, 255, 255, 0.7);">{{ n.name }}</span>
                <span style="font-weight: 600; color: #00d084;">{{ n.count }} livraisons</span>
            </li>
            {% empty %}
            <li style="padding: 12px 0; color: rgba(255, 255, 255, 0.5); text-align: center;">Aucune livraison pour
                l'instant</li>
            {% endfor %}
        </ul>
    </div>
</div>

{% if request.user.slug %}
<div class="card" style="border: 2px solid #00d084;">
    <div class="card-header">
        <h2>ğŸ”— Votre outil nÂ°1 : Le Lien de Vente</h2>
    </div>
    <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">
        Partagez ce lien sur Instagram, Facebook, WhatsApp pour que vos clients passent commande !
    </p>
    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
        <input type="text" id="magicLink" readonly
            style="flex: 1; min-width: 200px; padding: 12px 16px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #00d084; font-family: monospace; font-size: 0.9rem;"
            value="{{ request.scheme }}://{{ request.get_host }}/book/{{ request.user.slug }}/">
        <button onclick="copyMagicLink()" class="btn btn-primary" id="copyBtn">
            ğŸ“‹ Copier le lien
        </button>
        <a href="https://wa.me/?text=Passez%20votre%20commande%3A%20{{ request.scheme }}%3A%2F%2F{{ request.get_host }}%2Fbook%2F{{ request.user.slug }}%2F"
            target="_blank" class="btn btn-secondary" style="background: rgba(37, 211, 102, 0.2); color: #25d366;">
            ğŸ“± WhatsApp
        </a>
    </div>
</div>
{% endif %}

<!-- RECENT ORDERS -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“¦ DerniÃ¨res Commandes</h2>
        <a href="{% url 'partners:orders' %}" class="btn btn-secondary btn-sm">Voir tout â†’</a>
    </div>
    {% if stats.recent_orders %}
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Destinataire</th>
                <th>Statut</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for order in stats.recent_orders %}
            <tr>
                <td><code style="color: #00d084;">#{{ order.id|slice:":8" }}</code></td>
                <td>{{ order.recipient_name }}</td>
                <td><span class="status-badge status-{{ order.status|lower }}">{{ order.get_status_display }}</span>
                </td>
                <td style="color: rgba(255,255,255,0.5);">{{ order.created_at|date:"d/m H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px;">Aucune commande pour le moment.</p>
    {% endif %}
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Copy magic link
    function copyMagicLink() {
        const linkInput = document.getElementById('magicLink');
        const copyBtn = document.getElementById('copyBtn');

        navigator.clipboard.writeText(linkInput.value).then(() => {
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = 'âœ… CopiÃ© !';
            setTimeout(() => copyBtn.innerHTML = originalText, 2000);
        });
    }

    {% if is_approved and stats.chart_data %}
    // Chart.js - Orders Chart
    const ctx = document.getElementById('ordersChart').getContext('2d');
    const chartData = {{ stats.chart_data| safe }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [{
                label: 'Commandes',
                data: chartData.map(d => d.orders),
                borderColor: '#00d084',
                backgroundColor: 'rgba(0, 208, 132, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#00d084',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: 'rgba(255, 255, 255, 0.5)' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: 'rgba(255, 255, 255, 0.5)', stepSize: 1 }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}