{% extends 'partners/base.html' %}
{% load static %}

{% block title %}Commande #{{ delivery.id|slice:":8"|upper }}{% endblock %}

{% block page_title %}
ğŸ“¦ Commande <code>#{{ delivery.id|slice:":8"|upper }}</code>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 24px;">
    <span class="status-badge status-{{ delivery.status|lower }}">
        {{ delivery.get_status_display }}
    </span>
    <a href="{{ tracking_url }}" target="_blank" class="btn btn-primary btn-sm">ğŸ”— Tracking Live</a>
    {% if delivery.status != 'CANCELLED' %}
    <a href="{% url 'partners:dispute_create' delivery.id %}" class="btn btn-danger btn-sm"
        style="background: rgba(255, 82, 82, 0.2); color: #ff5252; border: 1px solid rgba(255,82,82,0.3);">
        âš ï¸ Signaler un litige
    </a>
    {% endif %}
    <a href="{% url 'partners:orders' %}" class="btn btn-secondary btn-sm">â† Retour</a>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card" style="text-align: center;">
        <div class="icon">ğŸ“</div>
        <div class="value">{{ delivery.distance_km|floatformat:1 }} <small style="font-size: 1rem;">km</small></div>
        <div class="label">Distance estimÃ©e</div>
    </div>
    <div class="kpi-card" style="text-align: center;">
        <div class="icon">ğŸ’°</div>
        <div class="value" style="color: #00d084;">{{ delivery.total_price|floatformat:0 }} <small
                style="font-size: 1rem;">XAF</small></div>
        <div class="label">Prix total</div>
    </div>
    <div class="kpi-card" style="text-align: center;">
        <div class="icon">ğŸ’³</div>
        <div class="value" style="font-size: 1.4rem; padding-top: 10px;">{{ delivery.get_payment_method_display }}</div>
        <div class="label">Mode de paiement</div>
    </div>
    <div class="kpi-card" style="text-align: center;">
        <div class="icon">ğŸ“…</div>
        <div class="value" style="font-size: 1.4rem; padding-top: 10px;">{{ delivery.created_at|date:"d/m H:i" }}</div>
        <div class="label">Date de crÃ©ation</div>
    </div>
</div>

<div class="grid-2" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
    <!-- Left Column -->
    <div>
        <!-- Delivery Info -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“‹ DÃ©tails de la commande</h2>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">ğŸ“¦ Description</span>
                    <span style="font-weight: 600;">{{ delivery.package_description }}</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">ğŸ‘¤ Destinataire</span>
                    <span style="font-weight: 600;">{{ delivery.recipient_name|default:"â€”" }}</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">ğŸ“ TÃ©lÃ©phone</span>
                    <span style="font-weight: 600;">{{ delivery.recipient_phone }}</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">ğŸ“ Retrait</span>
                    <span style="font-weight: 600; text-align: right;">{{ delivery.pickup_address|default:"GPS"
                        }}</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">ğŸ“ Livraison</span>
                    <span style="font-weight: 600; text-align: right;">
                        {% if delivery.dropoff_neighborhood %}
                        {{ delivery.dropoff_neighborhood.name }}
                        {% else %}
                        {{ delivery.dropoff_address|default:"GPS" }}
                        {% endif %}
                    </span>
                </div>
                {% if delivery.external_order_id %}
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">ğŸ”— RÃ©f. externe</span>
                    <span style="font-weight: 600; color: #00d084;">{{ delivery.external_order_id }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Courier Info -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸï¸ Coursier</h2>
            </div>
            {% if delivery.courier %}
            <div
                style="display: flex; align-items: center; gap: 16px; padding: 16px; background: rgba(0, 0, 0, 0.2); border-radius: 12px;">
                <div
                    style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #00d084, #00a86b); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    ğŸï¸</div>
                <div>
                    <h4 style="margin-bottom: 4px;">{{ delivery.courier.full_name }}</h4>
                    <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-bottom: 4px;">{{
                        delivery.courier.phone_number }}</p>
                    <span style="color: #ffc107; font-size: 0.9rem;">
                        â­ {{ delivery.courier.average_rating|floatformat:1 }}
                        <span style="color: rgba(255,255,255,0.4); font-size: 0.8rem;">({{
                            delivery.courier.total_deliveries_completed }} livraisons)</span>
                    </span>
                </div>
            </div>
            {% else %}
            <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 24px;">
                ğŸ” Aucun coursier assignÃ© pour le moment
            </p>
            {% endif %}
        </div>

        <!-- Financial Breakdown -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ’° DÃ©tail financier</h2>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">Prix total</span>
                    <span style="font-weight: 700; color: #00d084; font-size: 1.2rem;">{{
                        delivery.total_price|floatformat:0 }} XAF</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.5);">Commission plateforme</span>
                    <span>{{ delivery.platform_fee|floatformat:0 }} XAF</span>
                </div>
            </div>

            {% if transactions %}
            <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 0.95rem; color: rgba(255,255,255,0.7);">ğŸ“Š
                Transactions liÃ©es</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Montant</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions %}
                    <tr>
                        <td>{{ tx.get_transaction_type_display }}</td>
                        <td
                            style="font-weight: 600; color: {% if tx.amount >= 0 %}#00d084{% else %}#ff5252{% endif %};">
                            {% if tx.amount >= 0 %}+{% endif %}{{ tx.amount|floatformat:0 }} XAF
                        </td>
                        <td style="color: rgba(255,255,255,0.5);">{{ tx.created_at|date:"d/m H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>

    <!-- Right Column -->
    <div>
        <!-- Timeline -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“ Suivi temporal</h2>
            </div>
            <div style="position: relative; padding-left: 32px; display: flex; flex-direction: column; gap: 24px;">
                <div
                    style="position: absolute; left: 15px; top: 10px; bottom: 10px; width: 2px; background: rgba(255,255,255,0.1);">
                </div>
                {% for step in timeline %}
                <div style="position: relative;">
                    <div
                        style="position: absolute; left: -21px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: {% if step.done %}#00d084{% else %}rgba(255,255,255,0.2){% endif %}; border: 2px solid {% if step.done %}#00d084{% else %}rgba(255,255,255,0.3){% endif %}; {% if step.done %}box-shadow: 0 0 10px rgba(0,208,132,0.5);{% endif %}">
                    </div>
                    <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                        <span>{{ step.icon }}</span> {{ step.label }}
                    </div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.4);">
                        {% if step.time %}{{ step.time|date:"d/m H:i" }}{% else %}En attente...{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- OTP Codes -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ” Codes de sÃ©curitÃ©</h2>
            </div>

            <div
                style="background: rgba(156, 39, 176, 0.1); border: 1px solid rgba(156,39,176,0.3); padding: 16px; border-radius: 12px; margin-bottom: 12px; text-align: center;">
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 8px;">ğŸª Code Retrait
                    (Pickup)</div>
                <div
                    style="font-family: monospace; font-size: 1.8rem; font-weight: 700; color: #ce93d8; letter-spacing: 5px;">
                    {{ delivery.pickup_otp }}</div>
            </div>

            <div
                style="background: rgba(0, 208, 132, 0.1); border: 1px solid rgba(0,208,132,0.3); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 8px;">ğŸ“¦ Code Livraison
                </div>
                <div
                    style="font-family: monospace; font-size: 1.8rem; font-weight: 700; color: #00d084; letter-spacing: 5px;">
                    {{ delivery.otp_code }}</div>
            </div>

            <p style="margin-top: 16px; font-size: 0.8rem; color: rgba(255,255,255,0.4); line-height: 1.4;">
                âš ï¸ Le <strong>code retrait</strong> est Ã  donner au coursier. Le <strong>code livraison</strong> doit
                Ãªtre transmis au destinataire.
            </p>
        </div>
    </div>
</div>
{% endblock %}